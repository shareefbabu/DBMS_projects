{% extends "base.html" %}

{% block content %}
<div class="container" style="padding: 2rem 0;">
    <!-- Breadcrumb -->
    <div style="margin-bottom: 2rem; display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted);">
        {% if current_user.is_global_admin() %}
        <a href="{{ url_for('admin.manage_organizations') }}"
            style="color: var(--text-secondary); text-decoration: none;">Organizations</a>
        {% else %}
        <span style="color: var(--text-secondary);">Organization</span>
        {% endif %}
        <span>/</span>
        <span style="color: var(--text-primary);">{{ organization.name }}</span>
        <span>/</span>
        <span>Departments</span>
    </div>

    <div
        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h1 style="font-size: 1.8rem; margin-bottom: 0.5rem; line-height: 1.2;">{{ organization.name }} Departments
            </h1>
            <p style="color: var(--text-secondary);">Manage departments and teams structure.</p>
        </div>
        <button onclick="openCreateModal()" class="btn-primary"
            style="background: var(--accent-cyan); color: #fff; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 600; cursor: pointer; white-space: nowrap;">
            + New Department
        </button>
    </div>

    <!-- Departments List -->
    <div
        style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 12px; overflow: hidden;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: rgba(255,255,255,0.02); text-align: left;">
                    <th style="padding: 1rem; color: #ffffff; font-weight: 500;">Department Name</th>
                    <th style="padding: 1rem; color: #ffffff; font-weight: 500;">Description</th>
                    <th style="padding: 1rem; color: #ffffff; font-weight: 500;">Teams</th>
                    <th style="padding: 1rem; color: #ffffff; font-weight: 500;">Users</th>
                    <th style="padding: 1rem; color: #ffffff; font-weight: 500; text-align: right;">
                        Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for dept in departments %}
                <tr style="border-top: 1px solid var(--border-subtle); transition: background 0.2s;"
                    onmouseover="this.style.background='var(--bg-tertiary)'"
                    onmouseout="this.style.background='transparent'">
                    <td style="padding: 1rem; font-weight: 500;">
                        <span style="display: flex; align-items: center; gap: 0.5rem;">
                            üè¢ {{ dept.name }}
                        </span>
                    </td>
                    <td style="padding: 1rem; color: var(--text-secondary);">{{ dept.description or '-' }}</td>
                    <td style="padding: 1rem;">
                        <span
                            style="background: rgba(6, 182, 212, 0.1); color: var(--accent-cyan); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">
                            {{ dept.get_team_count() }} Teams
                        </span>
                    </td>
                    <td style="padding: 1rem; color: var(--text-primary);">
                        <span style="display: inline-flex; align-items: center; gap: 0.5rem;">
                            üë• {{ dept.get_user_count() }}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <a href="{{ url_for('admin.manage_teams', dept_id=dept.dept_id) }}"
                                style="padding: 0.5rem 1rem; background: var(--bg-tertiary); color: var(--text-primary); text-decoration: none; border: 1px solid var(--border-subtle); border-radius: 6px; font-size: 0.85rem; transition: all 0.2s;"
                                onmouseover="this.style.borderColor='var(--text-secondary)'"
                                onmouseout="this.style.borderColor='var(--border-subtle)'">
                                Manage Teams
                            </a>
                            <button onclick="deleteDept({{ dept.dept_id }})"
                                style="padding: 0.5rem 1rem; background: rgba(239, 68, 68, 0.1); color: var(--accent-red); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;"
                                onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'"
                                onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if not departments %}
        <div style="padding: 3rem; text-align: center; color: var(--text-muted);">
            No departments found. Create one to get started.
        </div>
        {% endif %}
    </div>
</div>

<!-- Create Modal -->
<div id="createModal" class="modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div
        style="background: var(--bg-card); width: 100%; max-width: 500px; padding: 2rem; border-radius: 12px; border: 1px solid var(--border-subtle);">
        <h2 style="margin-bottom: 1.5rem;">Create Department</h2>
        <form id="createForm" onsubmit="handleCreate(event)">
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Department
                    Name</label>
                <input type="text" name="name" required
                    style="width: 100%; padding: 0.75rem; background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary);">
            </div>
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Description</label>
                <textarea name="description" rows="3"
                    style="width: 100%; padding: 0.75rem; background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary);"></textarea>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" onclick="closeModals()"
                    style="padding: 0.75rem 1.5rem; background: transparent; border: 1px solid var(--border-subtle); color: var(--text-secondary); border-radius: 6px; cursor: pointer;">Cancel</button>
                <button type="submit"
                    style="padding: 0.75rem 1.5rem; background: var(--accent-cyan); border: none; color: white; border-radius: 6px; cursor: pointer;">Create</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openCreateModal() {
        document.getElementById('createModal').style.display = 'flex';
    }

    function closeModals() {
        document.getElementById('createModal').style.display = 'none';
    }

    async function handleCreate(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        try {
            const res = await fetch('{{ url_for("admin.create_department", org_id=organization.org_id) }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (result.success) {
                location.reload();
            } else {
                alert(result.message);
            }
        } catch (err) {
            alert('Error creating department');
        }
    }
</script>
{% endblock %}