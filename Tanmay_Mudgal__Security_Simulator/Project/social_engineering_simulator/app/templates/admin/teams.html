{% extends "base.html" %}

{% block content %}
<div class="container" style="padding: 2rem 0;">
    <!-- Breadcrumb -->
    <div style="margin-bottom: 2rem; display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted);">
        {% if current_user.is_global_admin() %}
        <a href="{{ url_for('admin.manage_organizations') }}"
            style="color: var(--text-secondary); text-decoration: none;">Organizations</a>
        {% else %}
        <span style="color: var(--text-secondary);">Organization</span>
        {% endif %}
        <span>/</span>
        <a href="{{ url_for('admin.manage_departments', org_id=department.org_id) }}"
            style="color: var(--text-secondary); text-decoration: none;">Departments</a>
        <span>/</span>
        <span style="color: var(--text-primary);">{{ department.name }}</span>
        <span>/</span>
        <span>Teams</span>
    </div>

    <div
        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h1 style="font-size: 1.8rem; margin-bottom: 0.5rem; line-height: 1.2;">{{ department.name }} Teams</h1>
            <p style="color: var(--text-secondary);">Manage teams and members.</p>
        </div>
        <button onclick="openCreateModal()" class="btn-primary"
            style="background: var(--accent-cyan); color: #fff; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 600; cursor: pointer; white-space: nowrap;">
            + New Team
        </button>
    </div>

    <!-- Teams List -->
    <div
        style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 12px; overflow: hidden;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: rgba(255,255,255,0.02); text-align: left;">
                    <th style="padding: 1rem; color: var(--text-secondary); font-weight: 500;">Team Name</th>
                    <th style="padding: 1rem; color: var(--text-secondary); font-weight: 500;">Description</th>
                    <th style="padding: 1rem; color: var(--text-secondary); font-weight: 500;">Members</th>
                    <th style="padding: 1rem; color: var(--text-secondary); font-weight: 500; text-align: right;">
                        Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for team in teams %}
                <tr style="border-top: 1px solid var(--border-subtle); transition: background 0.2s;"
                    onmouseover="this.style.background='var(--bg-tertiary)'"
                    onmouseout="this.style.background='transparent'">
                    <td style="padding: 1rem; font-weight: 500;">
                        <span style="display: flex; align-items: center; gap: 0.5rem;">
                            üõ°Ô∏è {{ team.name }}
                        </span>
                    </td>
                    <td style="padding: 1rem; color: var(--text-secondary);">{{ team.description or '-' }}</td>
                    <td style="padding: 1rem; color: var(--text-primary);">
                        <span onclick="openMembersModal({{ team.team_id }}, '{{ team.name }}')"
                            style="display: inline-flex; align-items: center; gap: 0.5rem; cursor: pointer; transition: opacity 0.2s;"
                            onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                            üë• {{ team.get_user_count() }}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <button onclick="openMembersModal({{ team.team_id }}, '{{ team.name }}')"
                                style="padding: 0.5rem 1rem; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-subtle); border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;"
                                onmouseover="this.style.borderColor='var(--text-secondary)'"
                                onmouseout="this.style.borderColor='var(--border-subtle)'">
                                üë• Members
                            </button>
                            <button
                                onclick="openEditModal({{ team.team_id }}, '{{ team.name }}', '{{ team.description or '' }}')"
                                style="padding: 0.5rem 1rem; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-subtle); border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;"
                                onmouseover="this.style.borderColor='var(--text-secondary)'"
                                onmouseout="this.style.borderColor='var(--border-subtle)'">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="deleteTeam({{ team.team_id }})"
                                style="padding: 0.5rem 1rem; background: rgba(239, 68, 68, 0.1); color: var(--accent-red); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s;"
                                onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'"
                                onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if not teams %}
        <div style="padding: 3rem; text-align: center; color: var(--text-muted);">
            No teams found. Create one to get started.
        </div>
        {% endif %}
    </div>
</div>

<!-- Create Modal -->
<div id="createModal" class="modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div
        style="background: var(--bg-card); width: 100%; max-width: 500px; padding: 2rem; border-radius: 12px; border: 1px solid var(--border-subtle);">
        <h2 style="margin-bottom: 1.5rem;">Create Team</h2>
        <form onsubmit="handleCreate(event)">
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Team Name</label>
                <input type="text" name="name" required
                    style="width: 100%; padding: 0.75rem; background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary);">
            </div>
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Description</label>
                <textarea name="description" rows="3"
                    style="width: 100%; padding: 0.75rem; background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary);"></textarea>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" onclick="closeModals()"
                    style="padding: 0.75rem 1.5rem; background: transparent; border: 1px solid var(--border-subtle); color: var(--text-secondary); border-radius: 6px; cursor: pointer;">Cancel</button>
                <button type="submit"
                    style="padding: 0.75rem 1.5rem; background: var(--accent-cyan); border: none; color: white; border-radius: 6px; cursor: pointer;">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div
        style="background: var(--bg-card); width: 100%; max-width: 500px; padding: 2rem; border-radius: 12px; border: 1px solid var(--border-subtle);">
        <h2 style="margin-bottom: 1.5rem;">Edit Team</h2>
        <form onsubmit="handleEdit(event)">
            <input type="hidden" id="editTeamId">
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Team Name</label>
                <input type="text" id="editName" name="name" required
                    style="width: 100%; padding: 0.75rem; background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary);">
            </div>
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Description</label>
                <textarea id="editDescription" name="description" rows="3"
                    style="width: 100%; padding: 0.75rem; background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary);"></textarea>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" onclick="closeModals()"
                    style="padding: 0.75rem 1.5rem; background: transparent; border: 1px solid var(--border-subtle); color: var(--text-secondary); border-radius: 6px; cursor: pointer;">Cancel</button>
                <button type="submit"
                    style="padding: 0.75rem 1.5rem; background: var(--accent-cyan); border: none; color: white; border-radius: 6px; cursor: pointer;">Save
                    Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Members Modal -->
<div id="membersModal" class="modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div
        style="background: var(--bg-card); width: 100%; max-width: 600px; padding: 2rem; border-radius: 12px; border: 1px solid var(--border-subtle); max-height: 90vh; overflow-y: auto;">
        <h2 id="membersModalTitle" style="margin-bottom: 1.5rem;">Manage Members</h2>
        <input type="hidden" id="memberTeamId">

        <!-- Add Member Section (Searchable) -->
        <div style="background: var(--bg-primary); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <h4 style="margin-bottom: 0.5rem; color: var(--text-secondary);">Add New Member</h4>

            <input type="text" id="userSearchInput" onkeyup="filterUsers()" placeholder="Search available users..."
                style="width: 100%; padding: 0.75rem; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary); margin-bottom: 0.5rem;">

            <div id="availableUsersList"
                style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-subtle); border-radius: 6px; background: var(--bg-card);">
                {% for user in available_users %}
                <div class="user-item-row" data-name="{{ user.username.lower() }} #{{ user.user_id }}"
                    style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border-subtle);">
                    <div>
                        <div style="font-weight: 500;">{{ user.username }} <span style="color: var(--accent-cyan);">#{{
                                user.user_id }}</span></div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">
                            {{ user.role.role_name if user.role else 'No Role' }} ‚Ä¢ {{ user.email }}
                        </div>
                    </div>
                    <button onclick="addMember({{ user.user_id }})"
                        style="padding: 0.4rem 0.8rem; background: var(--accent-cyan); border: none; color: white; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                        Add
                    </button>
                </div>
                {% endfor %}
                {% if not available_users %}
                <div style="padding: 1rem; text-align: center; color: var(--text-muted);">No available users found.
                </div>
                {% endif %}
            </div>
        </div>


        <!-- Current Members List -->
        <h4 style="margin-bottom: 0.5rem; color: var(--text-secondary);">Current Members</h4>
        <div id="membersList" style="display: flex; flex-direction: column; gap: 0.5rem;">
            {% for team in teams %}
            <!-- Hidden containers for each team's members to show dynamically -->
            <div id="team-members-{{ team.team_id }}" class="team-members-container" style="display: none;">
                {% if team.users %}
                {% for user in team.users %}
                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-primary); border-radius: 6px; border: 1px solid var(--border-subtle);">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <!-- Simple generic avatar -->
                        <div
                            style="width: 32px; height: 32px; background: var(--bg-tertiary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--text-secondary);">
                            {{ user.username[0] | upper }}
                        </div>
                        <div>
                            <div style="font-weight: 500;">{{ user.username }} <span
                                    style="color: var(--text-muted); font-size: 0.9em;">#{{ user.user_id }}</span></div>
                            <div style="font-size: 0.8rem; color: var(--accent-purple);">{{ user.role.role_name if
                                user.role else 'Member' }}</div>
                        </div>
                    </div>
                    <button onclick="removeMember({{ team.team_id }}, {{ user.user_id }})"
                        style="color: var(--accent-red); background: none; border: none; cursor: pointer; font-size: 0.8rem;">Remove</button>
                </div>
                {% endfor %}
                {% else %}
                <div style="color: var(--text-muted); text-align: center; padding: 1rem;">No members in this team.</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <div style="display: flex; justify-content: flex-end; margin-top: 1.5rem;">
            <button type="button" onclick="closeModals()"
                style="padding: 0.75rem 1.5rem; background: transparent; border: 1px solid var(--border-subtle); color: var(--text-secondary); border-radius: 6px; cursor: pointer;">Close</button>
        </div>
    </div>
</div>

<script>
    function openCreateModal() {
        document.getElementById('createModal').style.display = 'flex';
    }

    function openEditModal(id, name, description) {
        document.getElementById('editTeamId').value = id;
        document.getElementById('editName').value = name;
        document.getElementById('editDescription').value = description;
        document.getElementById('editModal').style.display = 'flex';
    }

    function openMembersModal(teamId, teamName) {
        document.getElementById('memberTeamId').value = teamId;
        document.getElementById('membersModalTitle').innerText = 'Manage Members - ' + teamName;

        // Hide all member lists first
        document.querySelectorAll('.team-members-container').forEach(el => el.style.display = 'none');

        // Show the specific team's list
        const list = document.getElementById('team-members-' + teamId);
        if (list) {
            list.style.display = 'block';
        }

        // Reset search
        document.getElementById('userSearchInput').value = '';
        filterUsers();

        document.getElementById('membersModal').style.display = 'flex';
    }

    function closeModals() {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    }

    function filterUsers() {
        const input = document.getElementById('userSearchInput');
        const filter = input.value.toLowerCase();
        const items = document.getElementsByClassName('user-item-row');

        for (let i = 0; i < items.length; i++) {
            const name = items[i].getAttribute('data-name');
            if (name.includes(filter)) {
                items[i].style.display = 'flex';
            } else {
                items[i].style.display = 'none';
            }
        }
    }

    async function handleCreate(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        try {
            const res = await fetch('{{ url_for("admin.create_team", dept_id=department.dept_id) }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (result.success) location.reload();
            else alert(result.message);
        } catch (err) {
            alert('Error creating team');
        }
    }

    async function handleEdit(e) {
        e.preventDefault();
        const id = document.getElementById('editTeamId').value;
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        try {
            const res = await fetch(`/admin/teams/${id}/edit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (result.success) location.reload();
            else alert(result.message);
        } catch (err) {
            alert('Error updating team');
        }
    }

    async function deleteTeam(id) {
        if (!confirm('Are you sure? This will remove all users from this team.')) return;
        try {
            const res = await fetch(`/admin/teams/${id}/delete`, { method: 'POST' });
            const result = await res.json();
            if (result.success) location.reload();
            else alert(result.message);
        } catch (err) {
            alert('Error deleting team');
        }
    }

    async function addMember(userId) {
        const teamId = document.getElementById('memberTeamId').value;
        try {
            const res = await fetch(`/admin/teams/${teamId}/members/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            });
            const result = await res.json();
            if (result.success) {
                location.reload();
            } else {
                alert(result.message);
            }
        } catch (err) {
            alert('Error adding member');
        }
    }

    async function removeMember(teamId, userId) {
        if (!confirm('Remove this user from the team?')) return;
        try {
            const res = await fetch(`/admin/teams/${teamId}/members/remove`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            });
            const result = await res.json();
            if (result.success) {
                location.reload();
            } else {
                alert(result.message);
            }
        } catch (err) {
            alert('Error removing member');
        }
    }

    // Close on click outside
    window.onclick = function (event) {
        if (event.target.classList.contains('modal')) {
            closeModals();
        }
    }
</script>
{% endblock %}