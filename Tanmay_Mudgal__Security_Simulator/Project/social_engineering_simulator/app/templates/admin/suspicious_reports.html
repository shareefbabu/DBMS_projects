{% extends "admin/admin_base.html" %}

{% block title %}Suspicious Usage Reports{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <h2 class="mb-4">üõ°Ô∏è Suspicious Reports Queue</h2>

    <div class="card bg-dark border-secondary shadow-lg">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0 align-middle">
                    <thead class="bg-black text-uppercase small text-muted">
                        <tr>
                            <th scope="col" class="ps-4">Date</th>
                            <th scope="col">User/Org</th>
                            <th scope="col">Category</th>
                            <th scope="col">Snippet</th>
                            <th scope="col">Screenshot</th>
                            <th scope="col">Status</th>
                            <th scope="col" class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if reports %}
                        {% for report in reports %}
                        <tr>
                            <td class="ps-4 text-nowrap">
                                <div class="fw-bold text-white">{{ report.created_at.strftime('%Y-%m-%d') }}</div>
                                <div class="small text-muted">{{ report.created_at.strftime('%H:%M') }}</div>
                            </td>
                            <td>
                                <div>{{ report.user.username }}</div>
                                <small class="text-muted">{{ report.organization.name }}</small>
                            </td>
                            <td><span class="badge bg-secondary">{{ report.category }}</span></td>
                            <td>
                                <div class="text-truncate" style="max-width: 200px;" title="{{ report.content_text }}">
                                    {{ report.content_text or 'No text content' }}
                                </div>
                            </td>
                            <td>
                                {% if report.screenshot_path %}
                                <a href="{{ url_for('static', filename='uploads/' + report.screenshot_path) }}"
                                    target="_blank" class="text-info text-decoration-none">
                                    View Image üìé
                                </a>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if report.status == 'Pending' %}
                                <span class="badge bg-warning text-dark">Pending</span>
                                {% elif report.status == 'Converted' %}
                                <span class="badge bg-success">Converted</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ report.status }}</span>
                                {% endif %}
                            </td>
                            <td class="text-end pe-4">
                                {% if report.status == 'Pending' %}
                                <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal"
                                    data-bs-target="#convertModal{{ report.report_id }}">
                                    Review & Convert
                                </button>
                                {% else %}
                                <button class="btn btn-sm btn-outline-secondary" disabled>Archived</button>
                                {% endif %}
                            </td>
                        </tr>

                        <!-- Convert Modal -->
                        <div class="modal fade" id="convertModal{{ report.report_id }}" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content bg-dark border-secondary">
                                    <div class="modal-header border-secondary">
                                        <h5 class="modal-title">Convert Report to Scenario</h5>
                                        <button type="button" class="btn-close btn-close-white"
                                            data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="alert alert-dark border-secondary mb-3">
                                            <strong>Original Report:</strong><br>
                                            <p class="mb-1 small">{{ report.content_text }}</p>
                                        </div>

                                        <form action="{{ url_for('admin.convert_report', report_id=report.report_id) }}"
                                            method="POST">
                                            <div class="mb-3">
                                                <label class="form-label">Scenario/Question Text</label>
                                                <textarea name="question_text"
                                                    class="form-control bg-black text-light border-secondary" rows="3"
                                                    required>You receive the following message: "{{ report.content_text[:100] }}..." - What is the safest action?</textarea>
                                            </div>

                                            <div class="row g-2 mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label text-muted small">Option 1</label>
                                                    <input type="text" name="option1"
                                                        class="form-control bg-black text-light border-secondary"
                                                        required placeholder="Suspicious action...">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label text-muted small">Option 2</label>
                                                    <input type="text" name="option2"
                                                        class="form-control bg-black text-light border-secondary"
                                                        required placeholder="Safe action...">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label text-muted small">Option 3</label>
                                                    <input type="text" name="option3"
                                                        class="form-control bg-black text-light border-secondary"
                                                        required placeholder="Neutral action...">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label text-muted small">Option 4</label>
                                                    <input type="text" name="option4"
                                                        class="form-control bg-black text-light border-secondary"
                                                        required placeholder="Risky action...">
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Correct Option (0-3)</label>
                                                <select name="correct_option"
                                                    class="form-select bg-black text-light border-secondary" required>
                                                    <option value="0">Option 1</option>
                                                    <option value="1">Option 2</option>
                                                    <option value="2">Option 3</option>
                                                    <option value="3">Option 4</option>
                                                </select>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Educational Explanation</label>
                                                <textarea name="explanation"
                                                    class="form-control bg-black text-light border-secondary" rows="2"
                                                    required>This is a {{ report.category }} attempt because...</textarea>
                                            </div>

                                            <div class="text-end">
                                                <button type="button" class="btn btn-secondary me-2"
                                                    data-bs-dismiss="modal">Cancel</button>
                                                <button type="submit" class="btn btn-success">Convert to
                                                    Scenario</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-5 text-muted">No pending reports found.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}