{% extends "base.html" %}

{% block title %}User Management - Admin{% endblock %}

{% block content %}
<style>
    .users-container {
        max-width: 100%;
        margin: 0;
        padding: 1.5rem;
    }

    .page-header {
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .page-header h1 {
        font-size: 2rem;
        color: #e2e8f0;
        font-weight: 700;
    }

    .users-table {
        background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        border: 1px solid #334155;
        border-radius: 12px;
        /* Removed overflow-x: auto to avoid scrollbar as requested */
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: rgba(255, 255, 255, 0.02);
    }

    th {
        color: #94a3b8;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        border-bottom: 1px solid #334155;
        white-space: nowrap;
    }

    td {
        padding: 0.75rem;
        color: #e2e8f0;
        border-bottom: 1px solid #1e293b;
    }

    tr:hover {
        background: rgba(255, 255, 255, 0.02);
    }

    .role-select {
        background: #0f172a;
        border: 1px solid #334155;
        color: #e2e8f0;
        padding: 0.5rem;
        border-radius: 6px;
        font-size: 0.875rem;
    }

    .role-select:focus {
        outline: none;
        border-color: #06b6d4;
    }

    .user-badge {
        background: rgba(6, 182, 212, 0.15);
        border: 1px solid #06b6d4;
        color: #06b6d4;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .user-badge.admin {
        background: rgba(239, 68, 68, 0.15);
        border-color: #ef4444;
        color: #ef4444;
    }

    .user-badge.org-admin {
        background: rgba(245, 158, 11, 0.15);
        border-color: #f59e0b;
        color: #f59e0b;
    }

    .user-badge.learner {
        background: rgba(16, 185, 129, 0.15);
        border-color: #10b981;
        color: #10b981;
    }

    .success-message {
        background: rgba(16, 185, 129, 0.15);
        border: 1px solid #10b981;
        color: #10b981;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: none;
    }
</style>

<div class="users-container">
    <div class="page-header">
        <h1>üë• User Management</h1>
    </div>

    <div id="successMessage" class="success-message">
        Role assigned successfully!
    </div>

    <div class="users-table">
        <table>
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Current Org</th>
                    <th>Assign Org</th>
                    <th>Current Role</th>
                    <th>Assign Role</th>
                    <th>Subscription Tier</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>
                        <strong>{{ user.username }}</strong>
                        <span style="color: var(--accent-cyan); font-size: 0.85em; margin-left: 0.5rem;">#{{
                            user.user_id }}</span>
                    </td>
                    <td style="word-break: break-all;">{{ user.email or '-' }}</td>
                    <td>{{ user.organization or '-' }}</td>
                    <td>
                        {% if current_user.is_global_admin() %}
                        <select class="role-select" id="org-{{ user.user_id }}" onchange="assignOrg({{ user.user_id }})"
                            style="width: 100%; max-width: 200px;">
                            <option value="">No Organization</option>
                            {% for org in organizations %}
                            <option value="{{ org.org_id }}" {% if user.org_id==org.org_id %}selected{% endif %}>
                                {{ org.name }}
                            </option>
                            {% endfor %}
                        </select>
                        {% else %}
                        <span style="color: var(--text-muted);">{{ user.organization or 'N/A' }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.role %}
                        {% if user.role.role_name == 'GLOBAL_ADMIN' %}
                        <span class="user-badge admin">{{ user.role.role_name }}</span>
                        {% elif user.role.role_name == 'ORG_ADMIN' %}
                        <span class="user-badge org-admin">{{ user.role.role_name }}</span>
                        {% else %}
                        <span class="user-badge learner">{{ user.role.role_name }}</span>
                        {% endif %}
                        {% else %}
                        <span class="user-badge">No Role</span>
                        {% endif %}
                    </td>
                    <td>
                        <select class="role-select" id="role-{{ user.user_id }}"
                            onchange="assignRole({{ user.user_id }})" style="width: 100%; max-width: 150px;">
                            {% for role in roles %}
                            <option value="{{ role.role_id }}" {% if user.role and user.role.role_id==role.role_id
                                %}selected{% endif %}>
                                {{ role.role_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        {% if current_user.is_global_admin() %}
                        <select class="role-select" id="tier-{{ user.user_id }}"
                            onchange="assignTier({{ user.user_id }})"
                            style="width: 100%; max-width: 120px; 
                            border-color: {% if user.subscription_tier == 'pro' %}var(--accent-amber){% else %}var(--border-subtle){% endif %};
                            color: {% if user.subscription_tier == 'pro' %}var(--accent-amber){% else %}var(--text-primary){% endif %};">
                            <option value="free" {% if user.subscription_tier !='pro' %}selected{% endif %}>Free
                            </option>
                            <option value="pro" {% if user.subscription_tier=='pro' %}selected{% endif %}>üèÜ Pro
                            </option>
                        </select>
                        {% else %}
                        <span class="user-badge" style="
                            {% if user.subscription_tier == 'pro' %}
                                background: rgba(245, 158, 11, 0.15); border-color: var(--accent-amber); color: var(--accent-amber);
                            {% endif %}">
                            {{ user.subscription_tier|upper }}
                        </span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    async function assignRole(userId) {
        const roleId = document.getElementById('role-' + userId).value;
        const successMsg = document.getElementById('successMessage');

        try {
            const response = await fetch(`/admin/users/${userId}/role`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ role_id: roleId })
            });

            const data = await response.json();

            if (data.success) {
                successMsg.textContent = data.message;
                successMsg.style.display = 'block';
                successMsg.style.backgroundColor = 'rgba(16, 185, 129, 0.15)'; // Reset success color
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to assign role. Please try again.');
        }
    }

    async function assignOrg(userId) {
        const orgId = document.getElementById('org-' + userId).value;
        const successMsg = document.getElementById('successMessage');

        try {
            const response = await fetch(`/admin/users/${userId}/organization`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ org_id: orgId })
            });

            const data = await response.json();

            if (data.success) {
                successMsg.textContent = data.message;
                successMsg.style.display = 'block';
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                alert('Error: ' + data.message);
                location.reload(); // Reset to previous state
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to assign organization.');
        }
    }

    async function assignTier(userId) {
        const tier = document.getElementById('tier-' + userId).value;
        const successMsg = document.getElementById('successMessage');

        try {
            const response = await fetch(`/admin/users/${userId}/tier`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tier: tier })
            });

            const data = await response.json();

            if (data.success) {
                successMsg.textContent = data.message;
                successMsg.style.display = 'block';
                // Use gold color for visual feedback if Pro
                if (tier === 'pro') {
                    successMsg.style.borderColor = 'var(--accent-amber)';
                    successMsg.style.color = 'var(--accent-amber)';
                    successMsg.style.backgroundColor = 'rgba(245, 158, 11, 0.15)';
                } else {
                    successMsg.style.borderColor = '#10b981';
                    successMsg.style.color = '#10b981';
                    successMsg.style.backgroundColor = 'rgba(16, 185, 129, 0.15)';
                }

                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                alert('Error: ' + data.message);
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to update subscription tier.');
        }
    }
</script>
{% endblock %}