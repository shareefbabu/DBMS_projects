{% extends "base.html" %}

{% block content %}
<div class="container" style="padding: 2rem 0;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h1 style="font-size: 1.8rem; margin-bottom: 0.5rem;">Organization Management</h1>
            <p style="color: var(--text-secondary);">Manage tenant organizations, branding, and access.</p>
        </div>
        <button onclick="openCreateModal()" class="btn-primary"
            style="background: var(--accent-cyan); color: #fff; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 600; cursor: pointer;">
            + New Organization
        </button>
    </div>

    <!-- Organizations List (Table Layout) -->
    <div
        style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 12px; overflow: hidden;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: rgba(255,255,255,0.02); text-align: left;">
                    <th style="padding: 1rem; color: var(--text-secondary); font-weight: 500;">Organization</th>
                    <th style="padding: 1rem; color: var(--text-secondary); font-weight: 500;">ID</th>
                    <th style="padding: 1rem; color: var(--text-secondary); font-weight: 500;">Users</th>
                    <th style="padding: 1rem; color: var(--text-secondary); font-weight: 500;">Departments</th>
                    <th style="padding: 1rem; color: var(--text-secondary); font-weight: 500;">Status</th>
                    <th style="padding: 1rem; color: var(--text-secondary); font-weight: 500; text-align: right;">
                        Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for org in organizations %}
                <tr style="border-top: 1px solid var(--border-subtle); transition: background 0.2s;"
                    onmouseover="this.style.background='var(--bg-tertiary)'"
                    onmouseout="this.style.background='transparent'">
                    <td style="padding: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div
                                style="width: 40px; height: 40px; border-radius: 8px; background: {{ org.primary_color }}; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: white;">
                                {{ org.name[0].upper() }}
                            </div>
                            <span style="font-weight: 500; font-size: 1rem;">{{ org.name }}</span>
                        </div>
                    </td>
                    <td style="padding: 1rem; color: var(--text-secondary); font-family: monospace;">#{{ org.org_id }}
                    </td>
                    <td style="padding: 1rem; color: var(--text-primary);">
                        <span style="display: inline-flex; align-items: center; gap: 0.5rem;">
                            üë• {{ org.get_user_count() }}
                        </span>
                    </td>
                    <td style="padding: 1rem; color: var(--text-primary);">
                        <span style="display: inline-flex; align-items: center; gap: 0.5rem;">
                            üè¢ {{ org.get_department_count() }}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <div
                            style="font-size: 0.8rem; color: {{ '#10b981' if org.is_active else '#ef4444' }}; background: {{ 'rgba(16, 185, 129, 0.1)' if org.is_active else 'rgba(239, 68, 68, 0.1)' }}; padding: 0.25rem 0.75rem; border-radius: 20px; display: inline-block;">
                            {{ 'Active' if org.is_active else 'Inactive' }}
                        </div>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <a href="{{ url_for('admin.manage_departments', org_id=org.org_id) }}"
                                style="padding: 0.5rem 1rem; background: var(--bg-tertiary); color: var(--text-primary); text-decoration: none; border: 1px solid var(--border-subtle); border-radius: 6px; font-size: 0.85rem; transition: all 0.2s;"
                                onmouseover="this.style.borderColor='var(--text-secondary)'"
                                onmouseout="this.style.borderColor='var(--border-subtle)'">
                                Manage Depts
                            </a>
                            <button
                                onclick="openEditModal({{ org.org_id }}, '{{ org.name }}', '{{ org.primary_color }}')"
                                style="padding: 0.5rem 1rem; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-subtle); border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;"
                                onmouseover="this.style.borderColor='var(--text-secondary)'"
                                onmouseout="this.style.borderColor='var(--border-subtle)'">
                                ‚úèÔ∏è Edit
                            </button>
                            <a href="{{ url_for('admin.export_org_summary', org_id=org.org_id) }}" target="_blank"
                                style="padding: 0.5rem 1rem; background: var(--bg-tertiary); color: var(--accent-cyan); text-decoration: none; border: 1px solid var(--border-subtle); border-radius: 6px; font-size: 0.85rem; transition: all 0.2s;"
                                onmouseover="this.style.borderColor='var(--accent-cyan)'"
                                onmouseout="this.style.borderColor='var(--border-subtle)'">
                                ‚¨áÔ∏è CSV
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if not organizations %}
        <div style="padding: 3rem; text-align: center; color: var(--text-muted);">
            No organizations found. create one to get started.
        </div>
        {% endif %}
    </div>
</div>

<!-- Create Modal -->
<div id="createModal" class="modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
    <div
        style="background: var(--bg-card); width: 100%; max-width: 500px; padding: 2rem; border-radius: 12px; border: 1px solid var(--border-subtle);">
        <h2 style="margin-bottom: 1.5rem;">Create Organization</h2>
        <form id="createForm" onsubmit="handleCreate(event)">
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Organization
                    Name</label>
                <input type="text" name="name" required
                    style="width: 100%; padding: 0.75rem; background: var(--bg-primary); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary);">
            </div>
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Primary
                    Color</label>
                <input type="color" name="primary_color" value="#06b6d4"
                    style="width: 100%; height: 40px; padding: 0; border: none; background: none; cursor: pointer;">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" onclick="closeModals()"
                    style="padding: 0.75rem 1.5rem; background: transparent; border: 1px solid var(--border-subtle); color: var(--text-secondary); border-radius: 6px; cursor: pointer;">Cancel</button>
                <button type="submit"
                    style="padding: 0.75rem 1.5rem; background: var(--accent-cyan); border: none; color: white; border-radius: 6px; cursor: pointer;">Create</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openCreateModal() {
        document.getElementById('createModal').style.display = 'flex';
    }

    function closeModals() {
        document.getElementById('createModal').style.display = 'none';
    }

    async function handleCreate(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        try {
            const res = await fetch('/admin/organizations/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (result.success) {
                location.reload();
            } else {
                alert(result.message);
            }
        } catch (err) {
            alert('Error creating organization');
        }
    }
</script>
{% endblock %}