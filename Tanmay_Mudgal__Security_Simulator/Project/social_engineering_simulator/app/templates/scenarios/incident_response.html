{% extends "base.html" %}

{% block content %}
<style>
    /* Flowchart / Interactive Drill Theme */
    .drill-container {
        padding: 3rem 0;
        max-width: 600px;
        margin: 0 auto;
    }

    .drill-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .drill-badge {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
        font-weight: 700;
        padding: 0.5rem 1rem;
        border-radius: 999px;
        font-size: 0.8rem;
        border: 1px solid rgba(245, 158, 11, 0.3);
        display: inline-block;
        margin-bottom: 1rem;
    }

    .process-flow {
        position: relative;
        padding-bottom: 2rem;
    }

    /* Spine removed by request */

    .flow-node {
        position: relative;
        z-index: 2;
        background: #0f172a;
        border: 2px solid #334155;
        padding: 0.75rem 2rem;
        margin-bottom: 3rem;
        color: #94a3b8;
        font-weight: 700;
        text-align: center;
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        border-radius: 50px;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.05em;
    }

    .flow-node.start-node {
        border-color: #10b981;
        color: #10b981;
        background: rgba(16, 185, 129, 0.05);
        box-shadow: 0 0 15px rgba(16, 185, 129, 0.1);
    }

    .flow-node.end-node {
        border-color: #06b6d4;
        color: #06b6d4;
        background: rgba(6, 182, 212, 0.05);
        margin-bottom: 0;
        box-shadow: 0 0 15px rgba(6, 182, 212, 0.1);
    }

    #sortable-list {
        list-style: none;
        padding: 0;
        margin: 0;
        position: relative;
        z-index: 1;
        max-width: 500px;
        margin: 0 auto;
    }

    .draggable-item {
        background: #1e293b;
        border: 1px solid #475569;
        border-left: 4px solid #3b82f6;
        border-radius: 6px;
        padding: 1rem 1.25rem;
        margin-bottom: 3rem;
        cursor: grab;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
    }

    .draggable-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        border-color: #94a3b8;
        background: #252e42;
    }

    .draggable-item:active,
    .draggable-item.dragging {
        cursor: grabbing;
        opacity: 0.95;
        transform: scale(1.02);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        z-index: 10;
        border-color: #3b82f6;
    }

    /* The Down Arrow (Chevron) - No line, just the head */
    .draggable-item::after {
        content: '';
        position: absolute;
        bottom: -1.8rem;
        left: 50%;
        width: 14px;
        height: 14px;
        background: transparent;
        border-right: 3px solid #64748b;
        border-bottom: 3px solid #64748b;
        transform: translateX(-50%) rotate(45deg);
        z-index: 20;
    }

    /* Remove the old auxiliary line, the main spine is enough */
    .draggable-item::before {
        display: none;
    }

    /* Start Node Arrow to first item */
    .flow-node.start-node::after {
        content: '';
        position: absolute;
        bottom: -2.5rem;
        left: 50%;
        width: 14px;
        height: 14px;
        background: transparent;
        border-right: 3px solid #64748b;
        border-bottom: 3px solid #64748b;
        transform: translateX(-50%) rotate(45deg);
        z-index: 20;
    }

    .item-content {
        flex: 1;
        font-size: 1.05rem;
        color: #e2e8f0;
        line-height: 1.5;
    }

    .submit-section {
        margin-top: 3rem;
        text-align: center;
    }

    .btn-submit {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: white;
        border: none;
        padding: 1rem 3rem;
        font-size: 1.1rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.5);
    }

    .btn-submit:hover {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.6);
    }

    .btn-submit:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
    }

    /* Result Modal Styling */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(10, 14, 39, 0.9);
        backdrop-filter: blur(5px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .result-modal {
        background: #1e293b;
        border: 2px solid #334155;
        padding: 2.5rem;
        border-radius: 16px;
        max-width: 700px;
        width: 90%;
        max-height: 85vh;
        overflow-y: auto;
        text-align: center;
        transform: scale(0.95);
        transition: all 0.3s ease;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .modal-overlay.active .result-modal {
        transform: scale(1);
    }

    .result-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        display: block;
    }

    .result-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #f3f4f6;
        margin-bottom: 1rem;
    }

    .result-message {
        color: #94a3b8;
        margin-bottom: 2rem;
        line-height: 1.6;
    }

    .modal-actions {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: white;
        text-decoration: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        border: none;
        cursor: pointer;
    }

    .btn-secondary {
        background: transparent;
        border: 1px solid #475569;
        color: #94a3b8;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-secondary:hover {
        background: #1e293b;
        color: #f3f4f6;
        border-color: #94a3b8;
    }

    .micro-lesson-card {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        text-align: left;
    }

    .lesson-tag {
        font-size: 0.75rem;
        color: #f59e0b;
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 0.05em;
        margin-bottom: 0.25rem;
        display: block;
    }

    .lesson-title {
        color: #e2e8f0;
        font-weight: 600;
    }

    /* Solution Display Styles */
    .solution-container {
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid #475569;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        text-align: left;
        display: none;
    }

    .solution-container.show {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    .solution-title {
        color: #06b6d4;
        font-size: 0.875rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 1rem;
    }

    .correct-sequence {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .correct-step {
        background: #1e293b;
        border-left: 3px solid #10b981;
        padding: 0.75rem 1rem;
        margin-bottom: 0.75rem;
        border-radius: 4px;
        color: #cbd5e1;
        display: grid;
        grid-template-columns: auto 1fr 1fr;
        gap: 1rem;
        align-items: start;
    }

    .step-number {
        color: #10b981;
        font-weight: 700;
        font-size: 0.875rem;
        min-width: 1.5rem;
    }

    .step-action {
        color: #e2e8f0;
        font-weight: 500;
        font-size: 0.9rem;
    }

    .step-why {
        color: #94a3b8;
        font-size: 0.85rem;
        font-style: italic;
    }

    .explanation-text {
        color: #94a3b8;
        line-height: 1.6;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #334155;
    }

    .btn-toggle-solution {
        background: transparent;
        border: 1px solid #06b6d4;
        color: #06b6d4;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 1rem;
    }

    .btn-toggle-solution:hover {
        background: rgba(6, 182, 212, 0.1);
        transform: translateY(-1px);
    }

    /* Responsive for solution */
    @media (max-width: 768px) {
        .correct-step {
            grid-template-columns: auto 1fr;
            gap: 0.5rem;
        }

        .step-why {
            grid-column: 2 / 3;
            margin-top: 0.25rem;
        }
    }
</style>

<div class="drill-container">
    <div class="drill-header">
        <span class="drill-badge">INCIDENT RESPONSE DRILL</span>
        <h1 style="color: #e2e8f0; margin-top: 1rem;">{{ scenario.difficulty_level }} Procedure</h1>
        <p style="color: #94a3b8; max-width: 500px; margin: 0.5rem auto;">
            {{ scenario.scenario_description }}
        </p>
    </div>

    <!-- The Flowchart Container -->
    <div class="process-flow">
        <!-- Static Start Node -->
        <div class="flow-node start-node">
            <span>ðŸš¨ ISSUE DETECTED</span>
        </div>

        <!-- Draggable Steps -->
        <ul id="sortable-list">
            {% for step in shuffled_steps %}
            <li class="draggable-item" draggable="true" data-step="{{ step }}">
                <span class="drag-handle">â˜°</span>
                <span class="item-content">{{ step }}</span>
            </li>
            {% endfor %}
        </ul>

        <!-- Static End Node -->
        <div class="flow-node end-node">
            <span>âœ… RESOLUTION</span>
        </div>
    </div>

    <div class="submit-section">
        <button id="submit-btn" class="btn-submit" onclick="submitDrill()">
            Execute Response Plan
        </button>
    </div>
</div>

<!-- Result Modal HTML -->
<div id="result-modal" class="modal-overlay">
    <div class="result-modal">
        <span id="result-icon" class="result-icon"></span>
        <h2 id="result-title" class="result-title"></h2>
        <p id="result-message" class="result-message"></p>

        <!-- Optional Micro Lesson Recommendation -->
        <div id="lesson-recommendation" style="display: none;">
            <div class="micro-lesson-card">
                <span class="lesson-tag">Recommended Micro-Lesson</span>
                <div id="lesson-info" class="lesson-title"></div>
            </div>
            <a id="lesson-btn" href="#" class="btn-primary"
                style="width: 100%; display: block; margin-bottom: 1rem; text-align: center;">
                Start Quick Lesson ðŸŽ“
            </a>
        </div>

        <!-- Solution/Explanation Section -->
        <div id="solution-section" class="solution-container">
            <div class="solution-title" id="solution-title">Correct Sequence</div>
            <ol class="correct-sequence" id="correct-steps"></ol>
            <div class="explanation-text" id="explanation-text"></div>
        </div>

        <div class="modal-actions">
            <button id="toggle-solution-btn" class="btn-toggle-solution" onclick="toggleSolution()"
                style="display: none;">
                See Solution
            </button>
            <a href="{{ url_for('main.dashboard') }}" class="btn-secondary" id="action-btn">Return to Dashboard</a>
        </div>
    </div>
</div>

<script>
    const list = document.getElementById('sortable-list');
    let draggedItem = null;

    list.addEventListener('dragstart', (e) => {
        draggedItem = e.target;
        e.target.classList.add('dragging');
        // setTimeout(() => e.target.style.opacity = '0.5', 0);
    });

    list.addEventListener('dragend', (e) => {
        e.target.classList.remove('dragging');
        draggedItem = null;
    });

    list.addEventListener('dragover', (e) => {
        e.preventDefault();
        const afterElement = getDragAfterElement(list, e.clientY);
        if (afterElement == null) {
            list.appendChild(draggedItem);
        } else {
            list.insertBefore(draggedItem, afterElement);
        }
    });

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.draggable-item:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    async function submitDrill() {
        const items = [...list.querySelectorAll('.draggable-item')];
        const currentOrder = items.map(item => item.getAttribute('data-step'));

        const btn = document.getElementById('submit-btn');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = 'Analyzing Sequence...';

        try {
            const response = await fetch('/submit-response', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                body: JSON.stringify({
                    scenario_id: {{ scenario.scenario_id }},
                response: JSON.stringify(currentOrder),
                response_time: 30
                })
    });

    const data = await response.json();

    if (response.ok) {
        showResult(data);
    } else {
        alert('Submission failed: ' + (data.error || 'Unknown error'));
        btn.disabled = false;
        btn.innerText = originalText;
    }
        } catch (e) {
        console.error(e);
        alert('Error submitting response. Check connection.');
        btn.disabled = false;
        btn.innerText = originalText;
    }
    }

    let correctSequence = [];
    let explanationData = '';
    let solutionVisible = false;

    // Step explanations mapping - provides context for each step
    const stepExplanations = {
        "Follow runbook: notify the on-call security/incident response or senior admin.": "Ensures immediate escalation to authorized personnel",
        "Isolate or restrict the affected server according to policy (e.g., move to quarantine VLAN).": "Prevents lateral spread of compromise",
        "Preserve logs and avoid rebooting or wiping systems unless instructed.": "Critical for forensic investigation",
        "Help collect initial evidence (logs, timestamps, IPs) as directed by IR team.": "Documents the incident for analysis",
        "Participate in post-incident review and implement any recommended hardening steps.": "Prevents future incidents through lessons learned"
    };

    function toggleSolution() {
        const solutionSection = document.getElementById('solution-section');
        const toggleBtn = document.getElementById('toggle-solution-btn');

        solutionVisible = !solutionVisible;

        if (solutionVisible) {
            solutionSection.classList.add('show');
            toggleBtn.innerText = 'Hide Solution';
        } else {
            solutionSection.classList.remove('show');
            toggleBtn.innerText = toggleBtn.getAttribute('data-original-text');
        }
    }

    function showResult(data) {
        const modal = document.getElementById('result-modal');
        const title = document.getElementById('result-title');
        const message = document.getElementById('result-message');
        const icon = document.getElementById('result-icon');
        const lessonContainer = document.getElementById('lesson-recommendation');
        const actionBtn = document.getElementById('action-btn');
        const toggleSolutionBtn = document.getElementById('toggle-solution-btn');
        const solutionSection = document.getElementById('solution-section');
        const correctStepsList = document.getElementById('correct-steps');
        const explanationText = document.getElementById('explanation-text');
        const solutionTitle = document.getElementById('solution-title');

        // Reset solution visibility
        solutionVisible = false;
        solutionSection.classList.remove('show');

        // Store the correct sequence from scenario data
        // We need to get this from the template
        const correctStepsData = {{ scenario.steps_json| safe
    }};
    explanationData = {{ scenario.explanation | tojson | safe }};

    if (data.correct) {
        icon.innerText = 'ðŸŽ‰';
        title.innerText = 'Incident Containment Successful!';
        message.innerText = `Great work! You followed the correct procedure.\n(+${data.score_gained} XP)`;
        title.style.color = '#10b981';
        lessonContainer.style.display = 'none';

        // Show "See Explanation" button
        toggleSolutionBtn.style.display = 'block';
        toggleSolutionBtn.innerText = 'See Explanation';
        toggleSolutionBtn.setAttribute('data-original-text', 'See Explanation');

        // Hide correct sequence, only show explanation
        solutionTitle.innerText = 'Why This Works';
        correctStepsList.style.display = 'none';
        explanationText.innerText = explanationData;

    } else {
        icon.innerText = 'âš ï¸';
        title.innerText = 'Procedure Failed';
        message.innerText = 'The sequence of actions was incorrect. In a real incident, this could lead to data loss or breach escalation.';
        title.style.color = '#ef4444';

        // Show "See Solution" button  
        toggleSolutionBtn.style.display = 'block';
        toggleSolutionBtn.innerText = 'See Solution';
        toggleSolutionBtn.setAttribute('data-original-text', 'See Solution');

        // Show correct sequence and explanation
        solutionTitle.innerText = 'Correct Sequence';
        correctStepsList.style.display = 'block';
        correctStepsList.innerHTML = '';

        // Populate correct steps with explanations
        correctStepsData.forEach((step, index) => {
            const li = document.createElement('li');
            li.className = 'correct-step';

            const stepNum = document.createElement('span');
            stepNum.className = 'step-number';
            stepNum.innerText = `${index + 1}.`;

            const stepAction = document.createElement('span');
            stepAction.className = 'step-action';
            stepAction.innerText = step;

            const stepWhy = document.createElement('span');
            stepWhy.className = 'step-why';
            stepWhy.innerText = stepExplanations[step] || 'Critical incident response step';

            li.appendChild(stepNum);
            li.appendChild(stepAction);
            li.appendChild(stepWhy);
            correctStepsList.appendChild(li);
        });

        explanationText.innerText = explanationData;

        // Show lesson recommendation if available
        if (data.recommended_lesson) {
            lessonContainer.style.display = 'block';
            document.getElementById('lesson-info').innerText = `${data.recommended_lesson.title} (${data.recommended_lesson.est_time} min)`;
            // Fix the link to point to the actual lesson player text or ID
            const lessonUrl = "{{ url_for('micro_lesson.view_lesson', lesson_id=0) }}".replace('0', data.recommended_lesson.lesson_id);
            document.getElementById('lesson-btn').href = lessonUrl;
            actionBtn.innerText = 'Skip & Return to Dashboard';
        } else {
            lessonContainer.style.display = 'none';
            actionBtn.innerText = 'Return to Dashboard';
        }
    }

    modal.classList.add('active');
    }
</script>
{% endblock %}