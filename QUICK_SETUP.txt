# QUICK SETUP GUIDE - Password Reset Feature
# ==========================================
# Follow these 3 simple steps to complete the integration

## STEP 1: Execute Database Schema (30 seconds)
# ---------------------------------------------
# Open Command Prompt or PowerShell as Administrator and run:

cd "d:\GIANDEEP MAIN\College Notes and notices\Sem 3\DBMS\DBMS PROJECT"
mysql -u root -pGDSingh@2026 FlightBookingDB < password_reset_schema.sql

# Verify it worked:
mysql -u root -pGDSingh@2026 FlightBookingDB -e "DESCRIBE password_reset_tokens;"

# You should see the table structure with columns: token_id, user_id, email, reset_token, etc.


## STEP 2: Add JavaScript Code to app.js (3 edits)
# ------------------------------------------------
# Open app.js in your editor and make these 3 additions:

### EDIT 1: Add API Method (around line 116, after getUserBookings)
# Find this section:
#     async getUserBookings() {
#         return await this.request('/bookings');
#     }
#
#     // Location endpoints
#     async getLocations() {

# ADD these lines BETWEEN getUserBookings and getLocations:

    // Password reset endpoints
    async forgotPassword(email) {
        return await this.request('/forgot-password', {
            method: 'POST',
            body: JSON.stringify({ email })
        });
    }


### EDIT 2: Add Handler Function (around line 787, BEFORE handleLogout)
# Find this line:
# async function handleLogout() {

# ADD this entire function BEFORE handleLogout:

async function handleForgotPassword(event) {
    event.preventDefault();
    
    const email = document.getElementById('forgotEmail').value.trim();
    
    if (!email) {
        UI.showToast('Error', 'Please enter your email address', 'error');
        return;
    }
    
    try {
        UI.showLoading();
        
        const response = await api.forgotPassword(email);
        
        if (response.success) {
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('resetLinkSent').style.display = 'block';
            
            if (response.dev_mode && response.reset_link) {
                const resetLinkDisplay = document.getElementById('resetLinkDisplay');
                resetLinkDisplay.innerHTML = `
                    <p style="margin-bottom: 0.5rem; font-weight: 600; color: var(--warning);">‚ö†Ô∏è Development Mode - Reset Link:</p>
                    <a href="${response.reset_link}" target="_blank" style="color: var(--primary-color); word-break: break-all; text-decoration: underline;">
                        ${response.reset_link}
                    </a>
                    <p style="margin-top: 0.75rem; font-size: 0.875rem; color: var(--text-secondary);">
                        Click the link above or check the server console for the reset email.
                    </p>
                `;
            }
            
            UI.showToast('Success', response.message || 'Reset link sent', 'success');
        } else {
            UI.showToast('Error', response.message || 'Failed to send reset link', 'error');
        }
        
    } catch (error) {
        UI.showToast('Error', error.message || 'Failed to send reset link', 'error');
    } finally {
        UI.hideLoading();
    }
}


### EDIT 3: Add Event Listeners (around line 905, in setupEventListeners function)
# Find this section:
#     document.getElementById('switchToLogin').addEventListener('click', (e) => {
#         e.preventDefault();
#         UI.hideModal('registerModal');
#         UI.showModal('loginModal');
#     });
#
#     // Booking modal

# ADD these lines BETWEEN switchToLogin and "// Booking modal":

    // Forgot Password modal
    document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
        e.preventDefault();
        UI.hideModal('loginModal');
        UI.showModal('forgotPasswordModal');
    });

    document.getElementById('backToLogin').addEventListener('click', (e) => {
        e.preventDefault();
        document.getElementById('forgotPasswordForm').style.display = 'block';
        document.getElementById('resetLinkSent').style.display = 'none';
        document.getElementById('forgotEmail').value = '';
        UI.hideModal('forgotPasswordModal');
        UI.showModal('loginModal');
    });

    document.getElementById('forgotPasswordClose').addEventListener('click', () => {
        document.getElementById('forgotPasswordForm').style.display = 'block';
        document.getElementById('resetLinkSent').style.display = 'none';
        document.getElementById('forgotEmail').value = '';
        UI.hideModal('forgotPasswordModal');
    });
    
    document.getElementById('forgotPasswordOverlay').addEventListener('click', () => {
        document.getElementById('forgotPasswordForm').style.display = 'block';
        document.getElementById('resetLinkSent').style.display = 'none';
        document.getElementById('forgotEmail').value = '';
        UI.hideModal('forgotPasswordModal');
    });
    
    document.getElementById('forgotPasswordForm').addEventListener('submit', handleForgotPassword);


## STEP 3: Test the Feature (2 minutes)
# -------------------------------------

# 1. Start the API server:
python api_server.py

# 2. Open browser to: http://localhost:5000/index.html

# 3. Test the flow:
#    - Click "Login"
#    - Click "Forgot Password?"
#    - Enter a registered email (check Users table or use test@example.com if it exists)
#    - Click "Send Reset Link"
#    - Check the server console - you'll see the reset link
#    - Copy and open the reset link
#    - Enter new password and submit
#    - Try logging in with the new password


## DONE! üéâ
# ========
# Your password reset feature is now fully functional!

# Features included:
# ‚úì Email verification
# ‚úì Secure token generation (SHA-256, 1-hour expiry)
# ‚úì Rate limiting (max 3 requests/hour/email)
# ‚úì Console logging for easy testing
# ‚úì Password updates in both MySQL and CSV
# ‚úì Professional HTML emails (when SMTP enabled)


## Need Help?
# ===========
# See PASSWORD_RESET_GUIDE.md for detailed documentation
# Or check forgot_password_integration.js for the code snippets
